
<%
include("/model/common.jag");
var user = session.get("user");
/*<!--
 ~ Copyright (c) WSO2 Inc. (http://www.wso2.org) All Rights Reserved.
 ~
 ~ Licensed under the Apache License, Version 2.0 (the "License");
 ~ you may not use this file except in compliance with the License.
 ~ You may obtain a copy of the License at
 ~
 ~      http://www.apache.org/licenses/LICENSE-2.0
 ~
 ~ Unless required by applicable law or agreed to in writing, software
 ~ distributed under the License is distributed on an "AS IS" BASIS,
 ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 ~ See the License for the specific language governing permissions and
 ~ limitations under the License.
 -->*/
 if (request.isSecure()) {//check whether the request is secure or not

    var authSuccess = session.get("authSuccess");
    if(!authSuccess){
        var queryParameters = request.getQueryString();
        if(queryParameters == "null" || queryParameters == null){
            response.sendRedirect("login?requestUrl=" + request.getRequestURI());
        } else{
            response.sendRedirect("login?requestUrl=" + request.getRequestURI() + "%3F" + request.getQueryString());
        }
    } else {
        include("/template/partials/header.jag");
        include("/template/partials/navigation.jag");									  
    }

} else {
    //request is not secured, therefore need redirect to the secure channel
    var queryStr = '';
    if (request.getQueryString() != null) {
        queryStr = '?' + request.getQueryString();
    }
    response.sendRedirect(application.get('serverAddress') + request.getRequestURI() + queryStr);
}	

	include("Controller/CtrlPerfilesBusqueda.jag");
	var xmlCatListas = getCatListas("");
	var xmlPerfiles = getPerfiles("");	
	var xmlAplicacion = getAplicacion("");
	var xmlOperacion = getOperacion("");
	var xmlOrigen = getOrigen("");
	//var xmlConfiguracion = getConfiguracion("");
	
 %>
 
		<link href="resources/plantilla/css/select2.css" rel="stylesheet" />
        <link href="resources/plantilla/css/dataTables.responsive.css" rel="stylesheet">

        <link rel='stylesheet prefetch' href='resources/plantilla/css/jquery.dataTables.min.css'> 
        <link rel='stylesheet prefetch' href='resources/plantilla/css/buttons.dataTables.min.css'>
        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
        <script src="resources/plantilla/js/html5shiv.js"></script>
        <script src="resources/plantilla/js/respond.min.js"></script>
        <![endif]-->
		
    

<div class="col-sm-10" >
    <div class="pageheader">
        <div class="media">
            <div class="pageicon pull-left">
                <i class="fa fa-th-list"></i>
            </div>
            <div class="media-body">
                <ul class="breadcrumb">
                    <li><a href="irBandejaEntrada"><i class="glyphicon glyphicon-home"></i></a></li>
                    <li><a>Visor</a></li>
                </ul>
                <h4>Perfilamiento de búsqueda</h4>
            </div>
        </div><!-- media -->
    </div><!-- pageheader -->
 <section>
    <div class="contentpanel">
        <p class="mb20"></p>
        <div class="panel panel-primary-head"> 
            <fieldset class="col-md-12">
            	<legend>Configuración de Perfiles de Búsqueda</legend>
				<div class="row">            
					<div class="col-xs-12 col-sm-12 col-md-6 col-lg-6">
						 <div class="col-xs-6 col-sm-6 col-md-6 col-lg-6">
							<div>Perfil:</div>
								<select id="slPerfil" name="slPerfil" class="form-control" style="width:80%">
									<%=createSelectPerfiles(xmlPerfiles)%>
								</select>
						</div>
						<div class="col-xs-6 col-sm-6 col-md-6 col-lg-6">
							<div id="modal">							
								<table id="tblListas" class="table-striped table-bordered table-list" style="margin-left:15%;">
									<thead><th style="display:none;"></th><th>Lista</th><th>%</th></thead>
									<tbody>							
										<%=createTableListas(xmlCatListas)%>
									</tbody>							
								</table>
							</div>
							<br/><br/><br/><br/>
						</div>					
						<div class="col-xs-12 col-sm-12 col-md-12 col-lg-12" style="width: 95%">				
							<table id="tblConfiguracion" class="table-striped table-bordered table-list">
								<thead>
									<th>Perfil</th>
									<th>Lista</th>
									<th>Categoría</th>
									<th style="display:none;"></th>
									<th style="display:none;"></th>
									<th style="display:none;"></th>
									<th style="display:none;"></th>
									<th style="display:none;"></th>
									<th style="display:none;"></th>
								</thead>
								<tbody>
								</tbody>							
							</table>
							<br/><br/><br/><br/>
							<div>&nbsp;</div>
						</div>
					</div>
					<div class="col-xs-12 col-sm-12 col-md-6 col-lg-6">
						<div class="col-xs-6 col-sm-6 col-md-12 col-lg-12">
							<table id="tblCategoria" class="table-striped table-bordered table-list">
								<thead>
									<th style="display:none;"></th>
									<th>Categoría</th>
									<th><input type="checkbox" name="cbAllCat" id="cbAllCat"></th>
									<th>Transacción</th>
									<th>Prioridad</th>
									<th style="display:none;"></th>
									<th style="display:none;"></th>
									<th style="display:none;"></th>
									<th style="display:none;"></th>
								</thead>
								<tbody>								
								</tbody>							
							</table>								
						</div>						
					</div>
					<div>
						<table style="width:86%;">
							<tr>
								<td align="right" style="padding-left:5%">
									<input class="btn btn-primary" type="button" value="Aplicar" id="btnAplicar" name="btnAplicar" >
								</td>
							</tr>				
						</table>
					</div>
				</div>	
			</fieldset>
			<fieldset class="col-md-12">
				<legend>Asignación de Perfiles a Aplicaciones</legend>
				<div class="row">					
					<div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">	
					  <br/>
					  	<h5>Opciones para On-Line</h5>
					  	<br/><br/>
						<div class="col-xs-2 col-sm-2 col-md-2 col-lg-3">
						<div>Aplicación:</div>
								<select id="slAplicacion" name="slAplicacion" class="form-control" style="width: 80%" >
									<%=createSelectAplicacion(xmlAplicacion)%>
								</select>
						</div>
						<div class="col-xs-2 col-sm-2 col-md-2 col-lg-3">
						<div>Operación:</div>
								<select id="slOperacion" name="slOperacion" class="form-control" style="width: 80%" >
									<%=createSelectOperacion(xmlOperacion)%>
								</select>
						</div>
						<div class="col-xs-2 col-sm-2 col-md-2 col-lg-2">
						<div>Origen del cliente:</div>
								<select id="slOrigen" name="slOrigen" class="form-control">
									<%=createSelectOrigen(xmlOrigen)%>
								</select>
						</div>
						<div class="col-xs-2 col-sm-2 col-md-2 col-lg-2">
							<table id="tblPerfil" class="table-striped table-bordered table-list" style="margin-left:auto;">
								<thead>
									<th style="display:none;"></th>
									<th>Perfil</th>
									<th></th>
								</thead>
								<tbody>	
								
								</tbody>							
							</table>
						</div>		
						<div class="col-xs-2 col-sm-2 col-md-2 col-lg-2">
							<table style="width:60%; margin-left:auto; margin-right:auto; margin-bottom:10%;">
								<tr>
									<td style="padding:7%">
										<input class="btn btn-primary" type="button" value="Aplicar" id="btnAplicarAsig" name="btnAplicarAsig" >
									</td>
								</tr>				
							</table>					
						</div>
							
					</div>
					<div class="row">					
					<div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
							<table id="tblperfilesAsig" class="table-striped table-bordered table-list">
								<thead>
									<th>Aplicación</th>
									<th>Operación</th>
									<th>Origen cliente</th>
									<th>Perfil</th>
									<th style="display:none;"></th>
									<th style="display:none;"></th>
									<th style="display:none;"></th>
								</thead>
								<tbody>							

								</tbody>							
							</table>
					</div>
					</div>	
					<br/><br/>	
				</div>	
			</fieldset>	
			<div class="modal fade" id="detalleConfiguracion">
			  <div class="modal-dialog">
				<div class="modal-content">
				  <div class="modal-header">
					<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
				  </div>
				  <div class="modal-body">
					<div id="idMessage">
					</div>	
					<input type="hidden" id="txtDetalleConfig" value=''>
				  </div>
				  <div class="modal-footer">
					<button type="button" class="btn btn-default" data-dismiss="modal">Cancelar</button>
					<button type="button" class="btn btn-primary" data-dismiss="modal" onclick="confirmaOperacion();">Aceptar</button>
				  </div>
				</div><!-- /.modal-content -->
			  </div><!-- /.modal-dialog -->
			</div><!-- /.modal -->
			<div class="modal fade" id="detalleConfiguracionAct">
			  <div class="modal-dialog">
				<div class="modal-content">
				  <div class="modal-header">
					<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
				  </div>
				  <div class="modal-body">
					<div id="idMessag">
					</div>	
					<input type="hidden" id="txtDetalleConf" value=''>
				  </div>
				  <div class="modal-footer">
					<button type="button" class="btn btn-default" data-dismiss="modal">Cancelar</button>
					<button type="button" class="btn btn-primary" data-dismiss="modal" onclick="confirmActualizaConf();">Aceptar</button>
				  </div>
				</div><!-- /.modal-content -->
			  </div><!-- /.modal-dialog -->
			</div><!-- /.modal -->
			<div class="modal fade" id="detalleAsignacion">
			  <div class="modal-dialog">
				<div class="modal-content">
				  <div class="modal-header">
					<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
				  </div>
				  <div class="modal-body">
					<div id="idMess">
					</div>	
					<input type="hidden" id="txtDetalleConf" value=''>
				  </div>
				  <div class="modal-footer">
					<button type="button" class="btn btn-default" data-dismiss="modal">Cancelar</button>
					<button type="button" class="btn btn-primary" data-dismiss="modal" >Aceptar</button>
				  </div>
				</div><!-- /.modal-content -->
			  </div><!-- /.modal-dialog -->
			</div><!-- /.modal -->
			<div class="modal fade" id="modalPorcentaje">
			  <div class="modal-dialog modal-sm">
				<div class="modal-content">
				  <div class="modal-header">
					<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
				  </div>
				  <div class="modal-body">	
					<div class="alert alert-warning">¿Desea actualizar el Porcentaje?</div>
						<br/>
						<table style="margin-left: auto">
							<tr>
								<td>Porcentaje: </td>
								<td style="padding-left: 7%;"><input type="text" id="txtPorcentaje" value='' style="width: 60%;" maxlength="3"></td>
							</tr>							
						</table>						
						<input type="hidden" id="txtId" value=''>
						<input type="hidden" id="txtLista" value=''>						
				  </div>
				  <div class="modal-footer">
					<button type="button" class="btn btn-default" data-dismiss="modal">Cancelar</button>
					<button type="button" class="btn btn-primary" data-dismiss="modal" onclick="getPorcentaje()">Aceptar</button>
				  </div>
				</div><!-- /.modal-content -->
			  </div><!-- /.modal-dialog -->
			</div><!-- /.modal -->
        </div><!-- panel-heading -->
    </div><!-- contentpanel -->
 </section>
 </div>
<script src='resources/plantilla/js/jquery-1.11.1.min.js'></script>
<script src='resources/plantilla/js/jquery.dataTables2.min.js'></script>
<script src='resources/plantilla/js/dataTables.buttons.js'></script>
<script src='resources/plantilla/js/buttons.flash.js'></script>
<script src='resources/plantilla/js/jszip.js'></script>
<script src='resources/plantilla/js/pdfmake.js'></script>
<script src='resources/plantilla/js/vfs_fonts.js'></script>
<script src='resources/plantilla/js/buttons.html5.js'></script>
<script src='resources/plantilla/js/buttons.print.js'></script>


<script src="resources/plantilla/js/bootstrap.min.js"></script>
<script src="resources/plantilla//js/dataTables.responsive.js"></script>
<script src="resources/plantilla/js/select2.min.js"></script>
<script src="resources/plantilla/js/custom.js"></script>
         

<script>
	
	
	jQuery(document).ready(function(){  
	
	$('#slAplicacion').change(function() {
	 	$('#slOperacion').val(0);	
	 	$('#slOrigen').val(0);	
		$('#tblPerfil tbody tr').remove();		
		$('#tblperfilesAsig tbody tr').remove();		
	 });
	
	$('#ModalProcesando').modal('show'); 	
		var lista = "";	
		var rowConfig = "";
		var slct ="";
		var cbPerfil="";
		var cbCategoria="";
		var iCat;
		var estatus=-1;
		var existe;
		var exito;
		var listAplicado;
		var listExiste;
		var rowListas='';
		var rowsAplicar=0;
		var xmlPrioridad= new XMLHttpRequest();
<<<<<<< HEAD
		var nuevaConf=true;
		var idListSelect ="";
		var listaConfig = "";
=======
>>>>>>> fa0793f798ed9d3f9e724809b81e8b1eed52580c
		
		// $('#porcentaje').click(function() {
			// $('#tblListas tbody tr input').remove();
			// var celda = $(this).find("td").eq(2);
			
			// var input = "<input type='text' name='txtPorcentaje' value='hola'/>";
			// celda.append(input);
			// $("#txtPorcentaje").focus();
			// $('#tblCategoria tbody tr').remove();
			// var dialogInstance3 = new BootstrapDialog()
				// .setTitle('Dialog instance 3')
				// .setMessage('Hi Everybody!')
				// .setType(BootstrapDialog.TYPE_INFO)
				// .open();			
		// });
		
	$('#ModalProcesando').modal('hide');
	});
	
	$('#tblListas tbody td').click(function() {
		$('#ModalProcesando').modal('show'); 
		rowListas = $(this).parent().index();
		var tr = $(this).parent(); 
		var idLista = tr.find("td").eq(0).html();
		idListSelect = idLista;
		lista = tr.find("td").eq(1).html();	
		var porcentaje = tr.find("td").eq(2).html();
		var idPerfil = $('select[name=slPerfil]').val();	
		
		if($(this).hasClass("porcentaje")){
			console.log("porcentaje " + porcentaje);
			$('#txtPorcentaje').val(porcentaje);
<<<<<<< HEAD
			$('#txtId').val(idLista);
=======
			$('#txtId').val(id);
>>>>>>> fa0793f798ed9d3f9e724809b81e8b1eed52580c
			$('#txtLista').val(lista);	
			$('#ModalProcesando').modal('hide'); 		
			$('#modalPorcentaje').modal({backdrop: 'static', keyboard: false})
		}else if ($(this).hasClass("lista")){			
			tr.addClass('highlight').siblings().removeClass('highlight');			
			//console.log("Lista " + id);
<<<<<<< HEAD
			$('#tblCategoria tbody tr').remove();
			if(idPerfil == 0){
				$('#ModalProcesando').modal('hide'); 
				 $("#idMsg").html('<div class="alert alert-danger">'+
					  'Seleccione un Perfil'+
					  '</div>');
				$('#ModalInfo').modal('show');
				return;
			}	
			getPrioridad();	
			getCategorias(idLista,idPerfil);
			//getCategorias2(idLista);
			
=======
			$('#tblCategoria tbody tr').remove();			
			getCategorias(id);
			getPrioridad();	
>>>>>>> fa0793f798ed9d3f9e724809b81e8b1eed52580c
		}
		
		
		// $('#tblListas tbody tr input').remove();
		// var celda = $(this).find("td").eq(2);
		
		// var input = "<input type='text' name='txtPorcentaje' value='hola'/>";
		// celda.append(input);
		// $("#txtPorcentaje").focus();
		// $('#tblCategoria tbody tr').remove();
		// $("#txtPorcentaje").change(function(){ 
			
		// }); 	
		
	});	
	
	function getPorcentaje(){	
	
		console.log("Actualiza porcentaje " );
		var porcentaje = $('#txtPorcentaje').val();
		if(porcentaje > 100){
			alert('El porcentaje no debe ser mayor a 100 %');
			return;
		}
		var idLista = $('#txtId').val();
		var sLista = $('#txtLista').val();
		rowListas = rowListas +1;
		
		actualizaPorcentaje(idLista, sLista, porcentaje)
		
		$('#tblListas tr:eq(' + rowListas + ') td:eq(2)').html(porcentaje);
		
	}
	
	function actualizaPorcentaje(_idLista, _sLista, _porcentaje){
		var usuario = "<%=user%>";
		var payload  = '<dat:qActualizaCatListas xmlns:dat="http://ws.wso2.org/dataservice" xmlns:dsb="dsBpmnVisorSEGListas">';
			payload += '<dat:idLista>'+_idLista+'</dat:idLista>';
			payload += '<dat:descLista>'+_sLista+'</dat:descLista>';
			payload += '<dat:descPorcentaje>'+_porcentaje+'</dat:descPorcentaje>';
			payload += '<dat:usuario>'+ usuario+'</dat:usuario>';
			payload += '</dat:qActualizaCatListas>';

		
		$.ajax({
			url: '/commons/postSOAP',
			type: 'post',
			headers: {'Destino':'BpmnVisorSEGListas', 'SOAPAction':'urn:qActualizaCatListas'},
			dataType: 'xml',
			complete: porcentjeResponse,
			error: function (xhr, status, error) {},
			data: payload
		});    
	}
	function porcentjeResponse(xmlHttpRequest, status){
		//alert(xmlHttpRequest.responseText);	
		
		var estatus=0;
		
		if($(xmlHttpRequest.responseText).find('qActualizaListasResponse').text() != ''){
			$(xmlHttpRequest.responseText).find('qActualizaListasResponse').each(function(){
				estatus = $(this).find("estatus").text();				
				if($(this).find("estatus").text()==1){
					  $("#idMsg").html('<div class="alert alert-success">'+
					  'Se ha actualizado correctamente ' +
					  '</div>');
				}else {
					  $("#idMsg").html('<div class="alert alert-danger">'+
					  'Sucedio un error '+$(this).find("codigoError").text()+
					  '</div>');
				 }
				 $('#ModalInfo').modal('show');
				
			});
		}
	}
	
	
	$("#cbAllCat").change(function(){  	 
		$(".cbCat").prop('checked', $(this).prop("checked")); 
		var option;
		if($(this).prop("checked")){
			iCat = 2;

			//getPrioridad();	
			$('.slPrioridad').prop('disabled', false);	
			var Select = $('.slPrioridad');
			Select.prop('disabled', false);		
		//		getPrioridad();
			$(xmlPrioridad.responseText).find('resultadoConsultaCatPrioridad').each(function(){	
				id =  $(this).find("id_prioridad").text();
				desc = $(this).find("descripcion").text();
				option = "";
				option += "<option value='" + id + "'>" + desc + "</option>";
				
				Select.append(option);
			//	Select.prop('disabled', true);
			});
	
		}else{
			$('.slPrioridad').prop('disabled', true);		 

			$('.slPrioridad')
				.find('option')
				.remove()
				.end()
				.append('<option value="0">- Seleccione -</option>');
		}
	});
	
	 function getCategorias(_idLista, _idPerfil){
		var payloadCateg  = '<dat:qGetMBConsultaCategoriaAplicado xmlns:dat="http://ws.wso2.org/dataservice" xmlns:dsb="dsBpmnVisorSEGListas">';
			payloadCateg += '<dat:idLista>'+_idLista+'</dat:idLista>';
			payloadCateg += '<dat:idPerfil>'+_idPerfil+'</dat:idPerfil>';
			payloadCateg += '</dat:qGetMBConsultaCategoriaAplicado>';

		
		$.ajax({
			url: '/commons/postSOAP',
			type: 'post',
			headers: {'Destino':'BpmnVisorSEGListas', 'SOAPAction':'urn:qGetMBConsultaCategoriaAplicado '},
			dataType: 'xml',
			complete: categoriasResponse,
			error: function (xhr, status, error) {},
			data: payloadCateg
		});                    
	}            
	
	
	function categoriasResponse(xmlHttpRequest, status){
		//alert(xmlHttpRequest.responseText);	
		var id="";
		var categoria="";
		var cont = 0;
		var idConfig = "";
		var idTran ="";
		var idPrioridad="";
		var idCategoria="";
		var Select = $('.slPrioridad');
		var option;

		$('#tblCategoria tbody tr').remove();

			
		
		if($(xmlHttpRequest.responseText).find('resultadoConsultaCateg').text() != ''){
			$(xmlHttpRequest.responseText).find('resultadoConsultaCateg').each(function(){
			cont++;
			id =  $(this).find("id_categListas").text();
			categoria = $(this).find("descCategoria").text();		
			idCategoria = $(this).find("id_categoria").text();		
			idConfig =  $(this).find("id_configuracion_perfil").text();
			idTran =  $(this).find("transaccion").text();
			idPrioridad =  $(this).find("id_prioridad").text();
			var trans = idTran=="true"?'checked':'';
			var chCategoria = idConfig !=""?'checked':'';
			var disabledSl = idConfig !=""?'':'disabled';
			var selectedPrio = '';
			var option = "";
			if(idConfig != ""){
				nuevaConf = false;
				$(xmlPrioridad.responseText).find('resultadoConsultaCatPrioridad').each(function(){	
					selectedPrio ='';
					var idPrio =  $(this).find("id_prioridad").text();
					var desc = $(this).find("descripcion").text();
					if(idPrioridad == idPrio ){
						selectedPrio = 'selected';
					}
					
					option += "<option value='" + idPrio+ "' "+selectedPrio +">" + desc + "</option>";

					//	Select.prop('disabled', true);
				});
			}

			var row="";			
			row += '<tr>';
			row += '<td style="display:none;">' + id + '</td>';
			row += '<td '+((idCategoria ==0)?'colspan="4")':'')+'">' + categoria + '</td>';
			row += '<td '+((idCategoria ==0)?'style="display:none;"':'')+'> <input type="checkbox" name="cbCategoria' + cont +'" id="cbCategoria" value="' + cont + '" onchange="actCategoria(this)" class ="cbCat" '+chCategoria+'></td>';
			row += '<td '+((idCategoria ==0)?'style="display:none;"':'')+'> <input type="checkbox" name="cbTransaccion' + cont + '" id="cbTransaccion" '+ trans +'></td>';
			row += '<td '+((idCategoria ==0)?'style="display:none;"':'')+'><select id="slPrioridad' + cont +'" name="slPrioridad' + cont +'" '+disabledSl+' class="slPrioridad" ><option value="0">- Seleccione -</option>'+option+'</select></td>';			
			row += '<td style="display:none;">' + idConfig + '</td>';
			row += '<td style="display:none;">' + idTran + '</td>';
			row += '<td style="display:none;">' + idPrioridad + '</td>';
			row += '<td style="display:none;">' + idCategoria + '</td>';
			row += '</tr>';
					
				$('#tblCategoria > tbody').append(row);
				$('#ModalProcesando').modal('hide'); 
			});
		}else{
			$('#ModalProcesando').modal('hide'); 
			console.log('no hay datos');
		}
	}
	
	//Consulta 
	function actCategoria (element){
		var dato = element.value;
		slct = dato;
		iCat = 1;
		var option;
		console.log(" Categoria: " + slct);
		if (element.checked){
			var Select = $('select[name="slPrioridad' + slct + '"]');
			Select.prop('disabled', false);		
		//		getPrioridad();
			$(xmlPrioridad.responseText).find('resultadoConsultaCatPrioridad').each(function(){	
				id =  $(this).find("id_prioridad").text();
				desc = $(this).find("descripcion").text();
				option = "";
				option += "<option value='" + id + "'>" + desc + "</option>";
				
				Select.append(option);
			//	Select.prop('disabled', true);
			});

		}else{
			$('select[name="slPrioridad' + slct + '"]').prop('disabled', true);		 

			$('select[name="slPrioridad' + slct + '"]')
				.find('option')
				.remove()
				.end()
				.append('<option value="0">- Seleccione -</option>');
		}
	}
	
	function getPrioridad(){
		var payloadPrio  = '<dat:qGetMBConsultaCatPrioridad xmlns:dat="http://ws.wso2.org/dataservice" xmlns:dsb="dsBpmnVisorSEGListas">';
			payloadPrio += '<dat:idPerfil></dat:idPerfil>';
			payloadPrio += '</dat:qGetMBConsultaCatPrioridad>';
		
		$.ajax({
			url: '/commons/postSOAP',
			type: 'post',
			headers: {'Destino':'BpmnVisorSEGListas', 'SOAPAction':'urn:qGetMBConsultaCatPrioridad'},
			dataType: 'xml',
			complete: prioridadResponse,
			error: function (xhr, status, error) {},
			data: payloadPrio
		});  
	}
	
	function prioridadResponse(xmlHttpRequest, status){
		//alert(xmlHttpRequest.responseText);	
		var id="";
		var descripcion="";
		var option;
		var Select;
/*		if(iCat == 1){
			var Select = $('select[name="slPrioridad' + slct + '"]');
		}else{
			var Select =  $('.slPrioridad');
		}
		
*/		
		var Select =  $('.slPrioridad');
		if($(xmlHttpRequest.responseText).find('resultadoConsultaCatPrioridad').text() != ''){
			xmlPrioridad = xmlHttpRequest;
		/*	
			$(xmlHttpRequest.responseText).find('resultadoConsultaCatPrioridad').each(function(){	
			id =  $(this).find("id_prioridad").text();
			descripcion = $(this).find("descripcion").text();
			option = "";
			option += "<option value='" + id + "'>" + descripcion + "</option>";
			
			Select.append(option);
		//	Select.prop('disabled', true);
			});

			*/
		}
	}
		
	
	$('#btnAplicar').click(function(){
		var usuario = "<%=user%>";
		var cont = 0;
		var cheked = 0;
		var categorias=[];
		var listElimina=[];
		var idConfig = "";
		var descCategoria = "";
		var idPerfil = $('select[name=slPerfil]').val();
		var sPerfil = $("#slPerfil").find("option:selected").text();
		console.log("idPerfil " + idPerfil);
		var transaccion="false";
		var porcent = $('.highlight').find('td').eq(2).text();
		$('#txtDetalleConfig').val(1);
		var lista = $('.highlight').find('td').eq(1).text();

		rowsAplicar = 0;
		existe = 0;
		exito = 0;
		listAplicado =[];
		listExiste =[];
		
		if(idPerfil == 0){
			 $("#idMsg").html('<div class="alert alert-danger">'+
				  'Seleccione un Perfil'+
				  '</div>');
			$('#ModalInfo').modal('show');
			return;
		}	
		$("#tblCategoria tbody tr").each(function(){
			cont++;
			 indexC = $(this).index()
			idConfig = $(this).find('td').eq(5).text();
			descCategoria = $(this).find('td').eq(1).text();
			var listaCat = "";
			var idPrioridad = "";
			//estatus =-3;
			
			var datos={};
			var datosElim = {};			
			if ($("input[name=cbCategoria" + cont +"]").is(":checked") || $(this).find('td').eq(8).text()==0) {
				rowConfig = indexC;
				cheked++;
				console.log("rowConfig " + rowConfig);
				 listaCat = $(this).find('td').eq(0).text();
				cbCategoria = $("input[name=cbCategoria" + cont +"]").val();
				if($(this).find('td').eq(8).text()!=0){
					
					if ($("input[name=cbTransaccion" + cont +"]").is(":checked") ) {
						transaccion = "true";
					}else{
						transaccion = "false";
					}				
					
					idPrioridad = $('select[name=slPrioridad' + cont +']').val();
					
					if(idPrioridad == "0"){
						 $("#idMsg").html('<div class="alert alert-danger">'+
							  'Seleccione una Prioridad'+
							  '</div>');
						$('#ModalInfo').modal('show');
						categorias=[];
						return false;
					}	
				}
				datos.idPerfil = idPerfil;
				datos.listaCat = listaCat;
				datos.transaccion = transaccion;
				datos.idPrioridad = idPrioridad;				
				datos.usuario = usuario;				
				datos.porcentaje = porcent;				
				datos.cbCategoria = cbCategoria;
				datos.rowConfig = rowConfig;
				datos.slPrioridadRow = cont;
				datos.idConfig = idConfig;
				datos.operacion = 1;		
				
				categorias.push(datos);
				
				//console.log("perfil " + perfil + " lista " + lista + " categoria " + categoria);
				//aplicaConfiguracion(idPerfil, listaCat, transaccion, idPrioridad, usuario,cbCategoria);	
			}else{
				
				if(idConfig != "" ){
						rowConfig = indexC;
						listaCat = $(this).find('td').eq(0).text();
						
						datosElim.idConfig = idConfig;	
						datosElim.descCategoria = descCategoria;	
						datosElim.idPerfil = idPerfil;	
						datosElim.lista = lista;
						listElimina.push(datosElim);		
						
						datos.idPerfil = idPerfil;
						datos.listaCat = listaCat;
						datos.transaccion = "";
						datos.idPrioridad = "";				
						datos.usuario = usuario;				
						datos.porcentaje = "";				
						datos.cbCategoria = "";
						datos.rowConfig = "";
						datos.slPrioridadRow = "";
						datos.idConfig = idConfig;
						datos.operacion = 2;
						
						categorias.push(datos);						
					}
			}
			
		//console.log("Estatus " +estatus);	
				
		});	
		if(listElimina.length > 0){
			var table="";
			listaConfig = categorias;
			for(var list in listElimina){	
					
					table += '<tr>';
					table += '<td style=" width: 30%">' +sPerfil+ '</td>';
					table += '<td style=" width: 30%">' +listElimina[list].lista+ '</td>';
					table += '<td style=" width: 30%">' +listElimina[list].descCategoria+ '</td>';
					table += '</tr>';

				}	
			$("#idMessage").html('<div class="alert alert-warning">'+
								'¿Desea eliminar las siguientes configuraciones? </div>' +
								'<div><table id="tblDetalleConfig">' +
								'  <tr>'+
								'   <td>'+
								'      <table class="table-striped table-bordered table-list" width="500" >'+
								'       <thead>'+
								'			<tr><th style=" width: 30%">Perfil</th>'+
								'				<th style=" width: 30%">Lista</th>'+
								'				<th  style=" width: 30%">Categoría</th>'+
								'			</tr></thead>'+
								'       </table>'+
								'    </td>'+
								'  </tr><tr>'+
								'  <td>'+
								'       <div style="width:500px; height:360px; overflow:auto;">'+
								'         <table class="table-striped table-bordered table-list" style="width:100%">'+
								'          <tbody>' + table +'</tbody>'	+						
								'         </table>' + 
								'       </div>'+
								'   </td>'+
								'  </tr>'+
								'</table>'+
								'<input type="hidden" id="txtOperacion" value=2 >' +
								'</div>');	


								


				$('#detalleConfiguracion').modal('show');		
		}else if(cheked > 0){
			var i = 1;
			listAplicado =[];
			listExiste =[];
			rowsAplicar = categorias.length;
			for(categoria in categorias){
				aplicaConfiguracion(categorias[categoria].idPerfil, categorias[categoria].listaCat, categorias[categoria].transaccion, categorias[categoria].idPrioridad, categorias[categoria].usuario, categorias[categoria].porcentaje,categorias[categoria].cbCategoria,categorias[categoria].slPrioridadRow, i,categorias[categoria].rowConfig,categorias[categoria].idConfig,categorias[categoria].operacion );	
				i++;
			}
			

		}else{
			if(idListSelect == 1 || idListSelect == 3 || idListSelect == 4 ){
					 $("#idMsg").html('<div class="alert alert-danger">'+
				  'Seleccione una categoria'+
				  '</div>');					
					$('#ModalInfo').modal('show');
					return;
			}
			
		}
			
		consultaConfig(idPerfil);	
		
	});
	var listaPerfilesAsig = [];
	function confirmaOperacion(){
		var operacion = $('#txtOperacion').val();
		if(operacion == 1){
			//Actualiza
			confirmActualizaConf();
		}else if(operacion == 2){			
			var i = 1;
			listAplicado =[];
			listExiste =[];
			rowsAplicar = listaConfig.length;
			for(c in listaConfig){
				aplicaConfiguracion(listaConfig[c].idPerfil, listaConfig[c].listaCat, listaConfig[c].transaccion, listaConfig[c].idPrioridad, listaConfig[c].usuario, listaConfig[c].porcentaje,listaConfig[c].cbCategoria,listaConfig[c].slPrioridadRow, i,listaConfig[c].rowConfig,listaConfig[c].idConfig,listaConfig[c].operacion );	
				i++;
			}			
		}else if(operacion ==3){
				var i = 1;
			rowsAplicar = listaPerfilesAsig.length;
			
			for(perfil in listaPerfilesAsig){
				altaAsignacion(listaPerfilesAsig[perfil].adAplic, listaPerfilesAsig[perfil].idOperacion, listaPerfilesAsig[perfil].idOrigen, listaPerfilesAsig[perfil].idPerfil, listaPerfilesAsig[perfil].cbPerfil,listaPerfilesAsig[perfil].rowPerfil, i, listaPerfilesAsig[perfil].operation );
				i++
			}
		}

	}

	function detalle(exito, existe){
		//$('#detalleConfiguracion').modal('hide');	
		console.log("exito " + exito);
		var idPerfil = $('select[name=slPerfil]').val();	
		console.log("existe " + existe);
		if(existe > 0){
				var table ='';
				var sPerfil = $("#slPerfil").find("option:selected").text();
				var lista = $('.highlight').find('td').eq(1).text();				
				for(var list in listExiste){	
					 var categoria = $('#tblCategoria tr:eq(' + (listExiste[list]+1)+ ') td:eq(1)').text();
					table += '<tr>';
					table += '<td style=" width: 30%">' +sPerfil+ '</td>';
					table += '<td style=" width: 30%">' +lista+ '</td>';
					table += '<td style=" width: 30%">' +categoria+ '</td>';
					table += '</tr>';
				}			
				
				$("#idMessag").html('<div class="alert alert-warning">'+
								'Las siguientes configuraciones ya existen. ¿Desea actualizarlas? </div>' +
								'<div><table id="tblDetalleConfig">' +
								'  <tr>'+
								'   <td>'+
								'      <table class="table-striped table-bordered table-list" width="500" >'+
								'       <thead>'+
								'			<tr><th style=" width: 30%">Perfil</th>'+
								'				<th style=" width: 30%">Lista</th>'+
								'				<th  style=" width: 30%">Categoría</th>'+
								'			</tr></thead>'+
								'       </table>'+
								'    </td>'+
								'  </tr><tr>'+
								'  <td>'+
								'       <div style="width:500px; height:360px; overflow:auto;">'+
								'         <table class="table-striped table-bordered table-list" style="width:100%">'+
								'          <tbody>' + table +'</tbody>'	+						
								'         </table>' + 
								'       </div>'+
								'   </td>'+
								'  </tr>'+
								'</table>'+
								'<input type="hidden" id="txtOperacion" value=1>' +
								'</div>');	
				$('#detalleConfiguracionAct').modal('show');		
			
			}else if(exito > 0){
				var table ='';
				var sPerfil = $("#slPerfil").find("option:selected").text();
				var lista = $('.highlight').find('td').eq(1).text();
				// for(var list in listAplicado){
					// var categoria = $('#tblCategoria tr:eq(' + listAplicado[list] + ') td:eq(1)').val();
					// table = '<tr>';
					// table += '<td>' +sPerfil+ '</td>';
					// table += '<td>' +lista+ '</td>';
					// table += '<td>' +categoria + '</td>';
					// table += '</tr>';
				// }
				
				$("#idMsg").html('<div class="alert alert-success">'+
										'Se han dado de alta correctamente ' +
										'</div>');	
				$('#ModalInfo').modal('show');	

<<<<<<< HEAD
				consultaConfig(idPerfil);			
=======
				getConfiguraciones();			
>>>>>>> fa0793f798ed9d3f9e724809b81e8b1eed52580c
			}	
		
		
	}
	
	function aplicaConfiguracion(_perfil, _lista, _transaccion, _prioridad, _usuario,_porcentaje, cbCategoria, _slPrioridad, cont, rowConf, _idConfig, _idOperacion){
	
		var payload  = '<dat:qInsertaConfiguracion xmlns:dat="http://ws.wso2.org/dataservice" xmlns:dsb="dsBpmnVisorSEGListas">';
			payload += '<dat:idPerfil>' + _perfil + '</dat:idPerfil>';
			payload += '<dat:idlistaCateg>' + _lista + '</dat:idlistaCateg>';
			payload += '<dat:transaccion>' + _transaccion + '</dat:transaccion>';
			payload += '<dat:idPrioridad>' + _prioridad + '</dat:idPrioridad>';
			payload += '<dat:estatusConf>1</dat:estatusConf>';
			payload += '<dat:estatusAprob>0</dat:estatusAprob>';
			payload += '<dat:usuarioAlta>' + _usuario + '</dat:usuarioAlta>';
			payload += '<dat:porcentaje>' + _porcentaje + '</dat:porcentaje>';
			payload += '<dat:idConfigura>' + _idConfig + '</dat:idConfigura>';
			payload += '<dat:operacionApl>' + _idOperacion + '</dat:operacionApl>';
			payload += '</dat:qInsertaConfiguracion>';	
		
		$.ajax({
			async:false,
			url: '/commons/postSOAP',
			type: 'post',
			headers: {'Destino':'BpmnVisorSEGListas', 'SOAPAction':'urn:qInsertaConfiguracion'},
			dataType: 'xml',
			complete: function configuraciondResponse(xmlHttpRequest, status){
				 //alert(xmlHttpRequest.responseText);				
				var dato;		
				$(xmlHttpRequest.responseText).find('resultadoConfiguracion').each(function(){
					estatus = $(this).find("estatus").text();				
					dato = rowConf 
					console.log("rowConf response" + rowConf);
					
					 if($(this).find("estatus").text()==1){	
					/* 	if(_idOperacion != 2){
					 		$("input[name=cbCategoria" + cbCategoria +"]").attr('checked',false);
							$('select[name="slPrioridad' + slPrioridad + '"]').prop('disabled', true);
					 	}								
					*/	
						exito++; 
						listAplicado.push(dato);
					}else if($(this).find("estatus").text()==0){
						existe++;
						listExiste.push(dato);										  
					}else {
						$("#idMsg").html('<div class="alert alert-danger">'+
										  'Sucedio un error al guardar la Configuración'+$(this).find("codigoError").text()+
										  '</div>');
						$('#ModalInfo').modal('show');
					 }
					if(rowsAplicar == cont){
						detalle(exito, existe);
					}
				});
				
				
					
			},
			error: function (xhr, status, error) {},
			data: payload
		}); 
   
	}
	
	
	
<<<<<<< HEAD
	
=======
	function responseConfig(xmlHttpRequest, status) {
		$("#tblConfiguracion >tbody").empty();
		
		$(xmlHttpRequest.responseText).find('resultadoConsultaConfiguracion').each(function() {
		
			var row = '<tr>';
				row += '<td>'+$(this).find("perfil").text()+'</td>';
				row += '<td>'+$(this).find("lista").text()+'</td>';
				row += '<td>'+$(this).find("categoria").text()+'</td>';
				row += '<td style="display:none">'+ $(this).find("id_configuracion_perfil").text()+'</td>';
				row += '<td style="display:none">'+$(this).find("id_perfil").text()+'</td>';
				row += '<td style="display:none">'+$(this).find("id_categ_listas").text()+'</td>';
				row += '<td style="display:none">'+$(this).find("transaccion").text()+'</td>';
				row += '<td style="display:none">'+$(this).find("id_prioridad").text()+'</td>';
				row += '<td style="display:none">'+$(this).find("prioridad").text()+'</td>';
				row += '</tr>';		
			$('#tblConfiguracion tbody').append(row);
        });
	}
>>>>>>> fa0793f798ed9d3f9e724809b81e8b1eed52580c
	
	function confirmActualizaConf(){
	//	$('detalleConfiguracion').hide();
		console.log("Entra actualizar");
		var configuracion = $('#txtDetalleConfig').val();
		if(configuracion == 1){
			var usuario = "<%=user%>";
			var cont = 0;
			var cheked = 0;
			var categorias=[];
			var listElimina=[];
			var idPerfil = $('select[name=slPerfil]').val();
			console.log("idPerfil " + idPerfil);
			var transaccion="false";
			var porcent = $('.highlight').find('td').eq(2).text();
			
			existe = 0;
			exito = 0;
			listAplicado =[];
			listExiste =[];
			datosElim = {};
			
			if(idPerfil == 0){
				 $("#idMsg").html('<div class="alert alert-danger">'+
					  'Seleccione un Perfil'+
					  '</div>');
				$('#ModalInfo').modal('show');
				return;
			}	
			$("#tblCategoria tbody tr").each(function(){
				cont++;
				var indexC = $(this).index()
				
				//estatus =-3;
				var idConfigElim = $(this).find('td').eq(5).text();
				var datos={};
				var listaCat = "";
				var idPrioridad ="";

				if ($("input[name=cbCategoria" + cont +"]").is(":checked") || $(this).find('td').eq(8).text() ==0) {
					rowConfig = indexC;
					cheked++;
					listaCat = $(this).find('td').eq(0).text();
					cbCategoria = $("input[name=cbCategoria" + cont +"]").val();
					
					
					if($(this).find('td').eq(8).text() !=0){
						if ($("input[name=cbTransaccion" + cont +"]").is(":checked") ) {
							transaccion = "true";
						}else{
							transaccion = "false";
						}				
						
						var idPrioridad = $('select[name=slPrioridad' + cont +']').val();
						
						if(idPrioridad == "0"){
							 $("#idMsg").html('<div class="alert alert-danger">'+
								  'Seleccione una Prioridad'+
								  '</div>');
							$('#ModalInfo').modal('show');
								categorias=[];
							return false;
						}	
					}	
					
					datos.idPerfil = idPerfil;
					datos.listaCat = listaCat;
					datos.transaccion = transaccion;
					datos.idPrioridad = idPrioridad;				
					datos.usuario = usuario;				
					datos.porcentaje = porcent;				
					datos.cbCategoria = cbCategoria;
					datos.rowConfig = rowConfig;
					datos.slPrioridad = cont;
					
					
					categorias.push(datos);
					
					//console.log("perfil " + perfil + " lista " + lista + " categoria " + categoria);
					//aplicaConfiguracion(idPerfil, listaCat, transaccion, idPrioridad, usuario,cbCategoria);	
				}
				else {					
					
				}
				
			//console.log("Estatus " +estatus);	
					
			});		
			if(categorias.length > 0){
				var i = 1;
				listAplicado =[];
				listExiste =[];
				rowsAplicar = categorias.length;
				for(categoria in categorias){
					actualizaConfiguracion(categorias[categoria].idPerfil, categorias[categoria].listaCat, categorias[categoria].transaccion, categorias[categoria].idPrioridad, categorias[categoria].porcentaje,categorias[categoria].cbCategoria,categorias[categoria].slPrioridad, i,categorias[categoria].rowConfig,categorias[categoria].idConfig,categorias[categoria].operacion );	
					i++;
				}
		/*	}else if(listElimina.length > 0){
				for(i in listElimina){
					eliminaConfiguracion(listElimina[i].idConfigElim);
				}
		*/		
			}else{
				 $("#idMsg").html('<div class="alert alert-danger">'+
					  'Seleccione una categoria'+
					  '</div>');
				$('#ModalInfo').modal('show');
				return;
			}

			consultaConfig(idPerfil);	
			
		}
	}	
	
	function actualizaConfiguracion(_idPerfil,_listaCat,_transaccion,_idPrioridad,_porsentaje,_cbCategoria, _slPrioridad,_rowconfig, idConfig, operacion){
			var usuario = "<%=user%>";
		//	console.log("idOrigen " + _idOrigen);
		var payload  = '<dat:qActualizaConfiguracionPerfil xmlns:dat="http://ws.wso2.org/dataservice" xmlns:dsb="dsBpmnVisorSEGListas">';
			payload += '<dat:idPerfil>' + _idPerfil + '</dat:idPerfil>';
			payload += '<dat:idCategListas>' + _listaCat + '</dat:idCategListas>';
			payload += '<dat:descTransaccion>' + _transaccion + '</dat:descTransaccion>';
			payload += '<dat:idPrioridad>' + _idPrioridad + '</dat:idPrioridad>';
			payload += '<dat:usuario>' + usuario + '</dat:usuario>';
			payload += '<dat:descPorcentaje>' + _porsentaje + '</dat:descPorcentaje>';
			payload += '</dat:qActualizaConfiguracionPerfil>';			
			
		//	console.log("payload " + payload);
			
		$.ajax({
			url: '/commons/postSOAP',
			type: 'post',
			headers: {'Destino':'BpmnVisorSEGListas', 'SOAPAction':'urn:qActualizaConfiguracionPerfil'},
			dataType: 'xml',
			complete: function asignacionResponse(xmlHttpRequest, status){
					$(xmlHttpRequest.responseText).find('resultadoActualizaConfiguracion').each(function(){
					 if($(this).find("estatus").text()==1){
						$("#idMsg").html('<div class="alert alert-success">'+
							'Se ha realizado la petición ' +
							'</div>');
						/*
						$("input[name=cbCategoria" + _cbCategoria +"]").attr('checked',false);
						$('select[name="slPrioridad' + _slPrioridad + '"]').prop('disabled', true);
					*/
					}else {
						  $("#idMsg").html('<div class="alert alert-danger">'+
						  'Sucedio un error '+$(this).find("codigoError").text()+
						  '</div>');
					 }
					 $('#ModalInfo').modal('show');
					 
					});
				},
			error: function (xhr, status, error) {},
			data: payload
		});  
	}
	
	function eliminaConfiguracion(_idConfiguracion){
		var payloadDel  = '<dat:qEliminaConfiguracion  xmlns:dat="http://ws.wso2.org/dataservice" xmlns:dsb="dsBpmnVisorSEGListas">';
			payloadDel += '<dat:idConfiguracion>' + _idConfiguracion + '</dat:idConfiguracion>';
			payloadDel += '</dat:qEliminaConfiguracion >';			
			
		//	console.log("payload " + payload);
			
		$.ajax({
			url: '/commons/postSOAP',
			type: 'post',
			headers: {'Destino':'BpmnVisorSEGListas', 'SOAPAction':'urn:qEliminaConfiguracion'},
			dataType: 'xml',
			complete: function asignacionResponse(xmlHttpRequest, status){
					$(xmlHttpRequest.responseText).find('resultadoEliminaCateg').each(function(){
					 if($(this).find("estatus").text()==1){
						$("#idMsg").html('<div class="alert alert-success">'+
							'Se ha realizado la petición ' +
							'</div>');					
					}else {
						  $("#idMsg").html('<div class="alert alert-danger">'+
						  'Sucedio un error '+$(this).find("codigoError").text()+
						  '</div>');
					 }
					 $('#ModalInfo').modal('show');
					 
					});
				},
			error: function (xhr, status, error) {},
			data: payloadDel
		});  
	}

	 $('select[name=slOrigen]').change(function() {
	 	var idApicacion = $('select[name=slAplicacion]').val();	
			var idOperacion = $('select[name=slOperacion]').val();
			var idOrigen = $('select[name=slOrigen]').val();
		getPerfilesApl(idApicacion, idOperacion,idOrigen);
	 	getPerfilesAsignados(idApicacion, idOperacion,idOrigen);	
	 });
	
	
	
	function validaDatos(element){
		var valido=false;
		if (element.checked){		
			
			var idApicacion = $('select[name=slAplicacion]').val();	
			var idOperacion = $('select[name=slOperacion]').val();
			var idOrigen = $('select[name=slOrigen]').val()
			
			if(idApicacion == 0){
				 $("#idMsg").html('<div class="alert alert-danger">'+
				  'Seleccione una Aplicación'+
				  '</div>');
				  valido=true;
			}else if(idOperacion == 0){
				 $("#idMsg").html('<div class="alert alert-danger">'+
				  'Seleccione una Operación'+
				  '</div>');
				  valido=true;
			}else if(idOrigen == 0){
				 $("#idMsg").html('<div class="alert alert-danger">'+
				  'Seleccione un Origen del Cliente'+
				  '</div>');
				  valido=true;
			}	
		}
		
		if(valido){
			$(this).attr('checked', false);
			$('#ModalInfo').modal('show');
			return;
		}
	}
	
	$('#btnAplicarAsig').click(function(){
		var valido=true;
		var idAplicacion = $('select[name=slAplicacion]').val();	
		var idOperacion = $('select[name=slOperacion]').val();
		var idOrigen = $('select[name=slOrigen]').val()
		var bPerfil = false;
		var sAplicacion = $("#slAplicacion").find("option:selected").text();
		var sOperacion = $("#slOperacion").find("option:selected").text();
		var sOrigen = $("#slOrigen").find("option:selected").text();

		rowsAplicar = 0;
		existe = 0;
		exito = 0;
		listAplicado =[];
		listExiste =[];
		$('#txtDetalleConfig').val(0);
		
		if(idAplicacion == 0){
			 $("#idMsg").html('<div class="alert alert-danger">'+
			  'Seleccione una Aplicación'+
			  '</div>');
			  valido=false;
		}else if(idOperacion == 0){
			 $("#idMsg").html('<div class="alert alert-danger">'+
			  'Seleccione una Operación'+
			  '</div>');
			  valido=false;
		}else if(idOrigen == 0){
			 $("#idMsg").html('<div class="alert alert-danger">'+
			  'Seleccione un Origen del Cliente'+
			  '</div>');
			  valido=false;
		}	
		
		if(!valido){
			$('#ModalInfo').modal('show');
			return;
		}
		 var perfiles =[];
		 var perfilesElim = [];
		
		 var cont = 0;
		$('input[name=cbPerfil]').each(function(){
			cont++;
			cbPerfil = "";
			var idPerfil="";
			var perfil = "";
			var data = {};
			var datos = {};
			 
			if ($(this).is(':checked') ) {
				bPerfil = true;				
				cbPerfil = $(this).val();	
			//	console.log("cbPerfil" +cbPerfil );
				var indx = $(this).parent().parent().index();	
				var tr = $("#tblPerfil > tbody").find("tr").eq(indx);
				idPerfil = tr.find("td").eq(0).text();	
			//	console.log("idOrigen " + idOrigen);
			
				data.adAplic = idAplicacion;
				data.idOperacion = idOperacion;
				data.idOrigen = idOrigen;
				data.idPerfil = idPerfil;
				data.cbPerfil = cbPerfil;
				data.rowPerfil = indx;
				data.operation = 1;			

				perfiles.push(data);				
				
			}else{
				cbPerfil = $(this).val();	
				var indx = $(this).parent().parent().index();	
				var tr = $("#tblPerfil > tbody").find("tr").eq(indx);
				idPerfil = tr.find("td").eq(0).text();
				perfil = tr.find("td").eq(1).text();

				var aplicado = tr.find("td").eq(3).text();
				if(aplicado != "0"){
					datos.adAplic = sAplicacion;
					datos.idOperacion = sOperacion;
					datos.idOrigen = sOrigen;
					datos.idPerfil = perfil;
					
					perfilesElim.push(datos);

					data.adAplic = idAplicacion;
					data.idOperacion = idOperacion;
					data.idOrigen = idOrigen;
					data.idPerfil = idPerfil;
					data.cbPerfil = cbPerfil;
					data.rowPerfil = indx;
					data.operation = 2;	
					perfiles.push(data);
				}
			}
			
		});
		listaPerfilesAsig = perfiles;
		if(!bPerfil){
			$("#idMsg").html('<div class="alert alert-danger">'+
			'Seleccione un Perfil'+
			'</div>');
			$('#ModalInfo').modal('show');
			return;
		}
		if(perfilesElim.length > 0){
			var table="";
		//	listaConfig = categorias;
			for(var list in perfilesElim){	
					
					table += '<tr>';
					table += '<td>' +perfilesElim[list].adAplic+ '</td>';
					table += '<td>' +perfilesElim[list].idOperacion+ '</td>';
					table += '<td>' +perfilesElim[list].idOrigen+ '</td>';
					table += '<td>' +perfilesElim[list].idPerfil+ '</td>';
					table += '</tr>';
				}	
			$("#idMessage").html('<div class="alert alert-warning">'+
								'¿Desea eliminar las siguientes configuraciones? </div>' +
								'<div><table id="tblDetalleConfig" class="table-striped table-bordered table-list">' +
								'<thead>' +
								'	<th>Aplicación</th>'+
								'	<th>Operación</th>'+
								'	<th>Origen cliente</th>'+
								'	<th>Perfil</th>'+
								'</thead>'+
								'<tbody>' + table +'</tbody>'+
								'</table>' +
								'<input type="hidden" id="txtOperacion" value=3 >' +
								'</div>');	
				$('#detalleConfiguracion').modal('show');	
		}else if(cont > 0){		
			var i = 1;
			rowsAplicar = perfiles.length;
			
			for(perfil in perfiles){
				altaAsignacion(perfiles[perfil].adAplic, perfiles[perfil].idOperacion, perfiles[perfil].idOrigen, perfiles[perfil].idPerfil, perfiles[perfil].cbPerfil,perfiles[perfil].rowPerfil, i, perfiles[perfil].operation );
				i++
			}
		}
		
		
		
		
	});



	
	function altaAsignacion(_idAplicacion, _idOperacion, _idOrigen, _idPerfil, cbPerfil, _rowPerfil, cont, operacion){
		var usuario = "<%=user%>";
		var relacion = "<%=Usuario_v%>";
	//	console.log("idOrigen " + _idOrigen);
	var payload  = '<dat:qInsertaAsignacionPerfil xmlns:dat="http://ws.wso2.org/dataservice" xmlns:dsb="dsBpmnVisorSEGListas">';
		payload += '<dat:idAplicacion>' + _idAplicacion + '</dat:idAplicacion>';
		payload += '<dat:idOperacion>' + _idOperacion + '</dat:idOperacion>';
		payload += '<dat:idOrigen>' + _idOrigen + '</dat:idOrigen>';
		payload += '<dat:idPerfil>' + _idPerfil + '</dat:idPerfil>';
		payload += '<dat:usuarioAlta>' + usuario + '</dat:usuarioAlta>';
		payload += '<dat:relacion>' + relacion + '</dat:relacion>';
		payload += '<dat:operacion>' + operacion + '</dat:operacion>';
		payload += '</dat:qInsertaAsignacionPerfil>';			
		
		//	console.log("payload " + payload);
			
		$.ajax({
			async:false,
			url: '/commons/postSOAP',
			type: 'post',
			headers: {'Destino':'BpmnVisorSEGListas', 'SOAPAction':'urn:qInsertaAsignacionPerfil'},
			dataType: 'xml',
			complete: function asignacionResponse(xmlHttpRequest, status){
				$(xmlHttpRequest.responseText).find('qInsertaAsignacionResponse').each(function(){
					var dato = '';
					dato = _rowPerfil;
					if($(this).find("estatus").text()==1){							
							exito++; 
							listAplicado.push(dato);
						  var cb = "#cbPerfil" + cbPerfil;
						   $(cb).attr('checked',false);
					}else if($(this).find("estatus").text()==0){
							existe++;
							listExiste.push(dato);		
					}else {
						$("#idMsg").html('<div class="alert alert-danger">'+
							'Sucedio un error '+$(this).find("codigoError").text()+
							'</div>');
						$('#ModalInfo').modal('show');	
					 }
									
						if(rowsAplicar == cont){
						detalleAsignacion(exito, existe);
					}					
				});
			},
			error: function (xhr, status, error) {},
			data: payload
		});  
	}
	
	function detalleAsignacion(_exito, _existe){
		var idApicacion = $('select[name=slAplicacion]').val();	
			var idOperacion = $('select[name=slOperacion]').val();
			var idOrigen = $('select[name=slOrigen]').val();
		console.log("exito " + exito);			
		console.log("existe " + existe);
		getPerfilesApl(idApicacion, idOperacion,idOrigen);
		getPerfilesAsignados(idApicacion, idOperacion,idOrigen);
		if(existe > 0){
			var table ='';					
			for(var list in listExiste){	
				 var perfil = $('#tblPerfil tr:eq(' + (listExiste[list]+1)+ ') td:eq(1)').text();
				 console.log("perfil " + perfil);
				table += '<tr>';
				table += '<td>' +perfil+ '</td>';	
				table += '</tr>';
			}			
			
			$("#idMess").html('<div class="alert alert-warning">'+
								'<p>No es posible autorizar los siguientes perfiles.</p><p>Ya cumplen con las características especificadas</p> </div>' +
								'<div><table id="tblDetalleAsig" class="table-striped table-bordered table-list">' +
								'<thead>' +
								'	<th>Perfil</th>'+
								'</thead>'+
								'<tbody>' + table +'</tbody>'+
								'</table>' +
								'</div>');	
			$('#detalleAsignacion').modal('show');		
			
		}else if(exito > 0){
			var sAplicacion = $("#slAplicacion option:selected").text();
			console.log("sAplicacion " +sAplicacion);
			var table ='';
			var sPerfil = $("#slPerfil").find("option:selected").text();
			var lista = $('.highlight').find('td').eq(1).text();
			var format = new Date(<%new Date();%>);
			var dia = format.getDate();
			var mm = format.getMonth()+1;
			var anio = format.getFullYear();
			var usuario = "<%=user%>";
			var tipo = 6;
			$('#form').empty();
			
			console.log(dia+mm+anio);
			if(dia < 10){
				dia = '0'+ dia;
			}
			if(mm < 10){
				mm = '0' + mm;
			}
			var date = dia+'/'+mm+'/'+anio;
			$.get("Mail", { action: "AltaPerfilBusqueda", aplicacion:sAplicacion, fecha:date, user:usuario, tipo:tipo, grup:'<%=Grupo_v%>'},
			function(data){
		   
			});
			$("#idMsg").html('<div class="alert alert-success">'+
									'Se han dado de alta correctamente ' +
									'</div>');	
			$('#ModalInfo').modal('show');	
			clerAsignacion();

		}
		getPerfilesAsignados(idApicacion, idOperacion,idOrigen);
	}

	function clerAsignacion(){
		$('#slAplicacion').val(0);
		$('#slOperacion').val(0);
		$('#slOrigen').val(0);
		$('input[name = cbPerfil]').attr('checked', false);
	}
	
	$('#slPerfil').change(function() {
		$("#tblConfiguracion >tbody").empty();
		$('#tblCategoria tbody tr').remove();
		$('#tblListas > tbody >tr').removeClass('highlight');
		if($(this).val() > 0){
			consultaConfig($(this).val());
		}
	});

	function consultaConfig(_idPerfil){
		var payloadConfig = '<dat:qGetMBConsultaConfiguracion xmlns:dat="http://ws.wso2.org/dataservice" xmlns:dsb="BpmnVisorSEGListas">';
		    payloadConfig += '<dat:idConfiguracion></dat:idConfiguracion>';
		    payloadConfig += '<dat:idPerfil>' + _idPerfil + '</dat:idPerfil>';
		    payloadConfig += '</dat:qGetMBConsultaConfiguracion>';
		    $.ajax({
		        url: '/commons/postSOAP',
		        type: 'post',
		        headers: {
		            'Destino': 'BpmnVisorSEGListas',
		            'SOAPAction': 'urn:qGetMBConsultaConfiguracion'
		        },
		        dataType: 'xml',
		        complete: responseConfig,
		        error: function(xhr, status, error) {},
		        data: payloadConfig
	    	});
	}

	function responseConfig(xmlHttpRequest, status) {
		$("#tblConfiguracion >tbody").empty();
		
		$(xmlHttpRequest.responseText).find('resultadoConsultaConfiguracion').each(function() {
		
			var row = '<tr>';
				row += '<td>'+$(this).find("perfil").text()+'</td>';
				row += '<td>'+$(this).find("lista").text()+'</td>';
				row += '<td>'+$(this).find("categoria").text()+'</td>';
				row += '<td style="display:none">'+ $(this).find("id_configuracion_perfil").text()+'</td>';
				row += '<td style="display:none">'+$(this).find("id_perfil").text()+'</td>';
				row += '<td style="display:none">'+$(this).find("id_categ_listas").text()+'</td>';
				row += '<td style="display:none">'+$(this).find("transaccion").text()+'</td>';
				row += '<td style="display:none">'+$(this).find("id_prioridad").text()+'</td>';
				row += '<td style="display:none">'+$(this).find("prioridad").text()+'</td>';
				row += '</tr>';		
			$('#tblConfiguracion tbody').append(row);
        });
	}


	 function getPerfilesAsignados(_iaAplicacion, _idOperacion,idOrigen){
		var payloadCateg  = '<dat:qGetPerfilesAsignados xmlns:dat="http://ws.wso2.org/dataservice" xmlns:dsb="dsBpmnVisorSEGListas">';
			payloadCateg += '<dat:idAplicacion>'+_iaAplicacion+'</dat:idAplicacion>';
			payloadCateg += '<dat:idOperacion>'+_idOperacion+'</dat:idOperacion>';
			payloadCateg += '<dat:idOrigen>'+idOrigen+'</dat:idOrigen>';
			payloadCateg += '</dat:qGetPerfilesAsignados >';

		
		$.ajax({
			url: '/commons/postSOAP',
			type: 'post',
			headers: {'Destino':'BpmnVisorSEGListas', 'SOAPAction':'urn:qGetPerfilesAsignados  '},
			dataType: 'xml',
			complete: perilesResponse,
			error: function (xhr, status, error) {},
			data: payloadCateg
		});                    
	}            
	
	
	function perilesResponse(xmlHttpRequest, status){
		//alert(xmlHttpRequest.responseText);	
		var id="";
		var categoria="";
		var cont = 0;
		var idConfig = "";
		var idTran ="";
		var idPrioridad="";
		var Select = $('.slPrioridad');
		var option;

		$('#tblperfilesAsig tbody tr').remove();

			
		
		if($(xmlHttpRequest.responseText).find('resultadoPerfiles').text() != ''){
			$(xmlHttpRequest.responseText).find('resultadoPerfiles').each(function(){
			cont++;
			var idPerfAsig =  $(this).find("id_perfil_asignados").text();
			var aplicacion = $(this).find("aplicacion").text();		
			var operacion =  $(this).find("operacion").text();
			var origen =  $(this).find("origen").text();
			var perfil =  $(this).find("perfil").text();
			var estatusapr =  $(this).find("estatus_aprobo").text();

			var row="";			
			row += '<tr>';
			row += '<td ">' + aplicacion + '</td>';
			row += '<td>' + operacion + '</td>';
			row += '<td>' + origen + '</td>';						
			row += '<td>' + perfil + '</td>';						
			row += '<td style="display:none;">' + estatusapr + '</td>';
			row += '<td style="display:none;">' + idPerfAsig + '</td>';
			row += '</tr>';
					
				$('#tblperfilesAsig > tbody').append(row);
				$('#ModalProcesando').modal('hide'); 
			});
		}
	}

	 function getPerfilesApl(_iaAplicacion, _idOperacion,idOrigen){
		var payloadCateg  = '<dat:qGetPerfilesApl  xmlns:dat="http://ws.wso2.org/dataservice" xmlns:dsb="dsBpmnVisorSEGListas">';
			payloadCateg += '<dat:idAplicacion>'+_iaAplicacion+'</dat:idAplicacion>';
			payloadCateg += '<dat:idOperacion>'+_idOperacion+'</dat:idOperacion>';
			payloadCateg += '<dat:idOrigen>'+idOrigen+'</dat:idOrigen>';
			payloadCateg += '</dat:qGetPerfilesApl  >';

		
		$.ajax({
			url: '/commons/postSOAP',
			type: 'post',
			headers: {'Destino':'BpmnVisorSEGListas', 'SOAPAction':'urn:qGetPerfilesApl   '},
			dataType: 'xml',
			complete: perilesAplResponse,
			error: function (xhr, status, error) {},
			data: payloadCateg
		});                    
	}            
	
	
	function perilesAplResponse(xmlHttpRequest, status){
		//alert(xmlHttpRequest.responseText);	
		var id="";
		var cont = 0;
		var idConfig = "";
		var idTran ="";
		var option;

		$('#tblPerfil tbody tr').remove();

			
		
		if($(xmlHttpRequest.responseText).find('resultadoPerfiles').text() != ''){
			$(xmlHttpRequest.responseText).find('resultadoPerfiles').each(function(){
			cont++;
			var idPerfil =  $(this).find("id_perfil").text();
			var perfil =  $(this).find("perfil").text();
			var aplicado =  $(this).find("aplicado").text();			
			var result="";	
			var chPerfil = aplicado != 0?'checked':'';
			if(aplicado > 0){

			}

				result += '<tr>';
				result += '<td style="display:none">'+idPerfil+'</td>';
				result += '<td>'+perfil+'</td>';				
				result += '<td> <input type="checkbox" name="cbPerfil" id="cbPerfil' + cont +'" onclick="validaDatos(this)" value="' + idPerfil + '" '+chPerfil+'></td>';
				result += '<td style="display:none">'+aplicado+'</td>';				
				result += '</tr>';				
					
				$('#tblPerfil > tbody').append(result);
				$('#ModalProcesando').modal('hide'); 
			});
		}
	}
	
	
	///fdghklñkjgfdghkljfdghkljgfdghjklgfdxcgjkljfxdghkljhfvcbnñlkjxc
	
	
	
	
	
	 function getCategorias2(_idLista){
		var payloadCateg  = '<dat:qGetCategoriaLista  xmlns:dat="http://ws.wso2.org/dataservice" xmlns:dsb="dsBpmnVisorSEGListas">';
			payloadCateg += '<dat:idLista>'+_idLista+'</dat:idLista>';
			payloadCateg += '</dat:qGetCategoriaLista >';

		
		$.ajax({
			url: '/commons/postSOAP',
			type: 'post',
			headers: {'Destino':'BpmnVisorSEGListas', 'SOAPAction':'urn:qGetCategoriaLista '},
			dataType: 'xml',
			complete: categoriasResponse2,
			error: function (xhr, status, error) {},
			data: payloadCateg
		});                    
	}            
	
	
	function categoriasResponse2(xmlHttpRequest, status){
		//alert(xmlHttpRequest.responseText);	
		
		$('#tblCategoria tbody tr').remove();

			
		var cont =0;
		if($(xmlHttpRequest.responseText).find('qGetCategoriaListaResponse').text() != ''){
			$(xmlHttpRequest.responseText).find('resultadoCatListas').each(function(){
		 cont++;
			var id =  $(this).find("id_categ_listas").text();
			var categoria = $(this).find("categoria").text();		
			var idCategoria = $(this).find("id_categoria").text();		
			var idConfig =  $(this).find("id_configuracion_perfil").text();
			var idTran =  $(this).find("transaccion").text();
			var idPrioridad =  $(this).find("id_prioridad").text();
			var trans = idTran=="true"?'checked':'';
			var chCategoria = idConfig !=""?'checked':'';
			var disabledSl = idConfig !=""?'':'disabled';
			var selectedPrio = '';
			var option = "";
			

			var row="";			
			row += '<tr>';
			row += '<td style="display:none;">' + id + '</td>';
			row += '<td '+((idCategoria ==0)?'colspan="4")':'')+'">' + categoria + '</td>';
			row += '<td '+((idCategoria ==0)?'style="display:none;"':'')+'> <input type="checkbox" name="cbCategoria' + cont +'" id="cbCategoria" value="' + cont + '" onchange="actCategoria(this)" class ="cbCat" '+chCategoria+'></td>';
			row += '<td '+((idCategoria ==0)?'style="display:none;"':'')+'> <input type="checkbox" name="cbTransaccion' + cont + '" id="cbTransaccion" '+ trans +'></td>';
			row += '<td '+((idCategoria ==0)?'style="display:none;"':'')+'><select id="slPrioridad' + cont +'" name="slPrioridad' + cont +'" '+disabledSl+' class="slPrioridad" ><option value="0">- Seleccione -</option>'+option+'</select></td>';			
			row += '<td style="display:none;">' + idCategoria + '</td>';
			row += '</tr>';
					
				$('#tblCategoria > tbody').append(row);
				$('#ModalProcesando').modal('hide'); 
			});
		}else{
			$('#ModalProcesando').modal('hide'); 
			console.log('no hay datos');
		}
	}

</script>